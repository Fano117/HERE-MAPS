{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/Alfredo/Documents/HERE-MAPS/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { interval } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../../services/here-maps.service\";\nimport * as i2 from \"../../services/address.service\";\nimport * as i3 from \"@angular/common/http\";\nimport * as i4 from \"@angular/common\";\nimport * as i5 from \"@angular/forms\";\nconst _c0 = [\"trackingMap\"];\nfunction TrackingViewComponent_option_9_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"option\", 15);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const driver_r2 = ctx.$implicit;\n    i0.ɵɵproperty(\"value\", driver_r2.id);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate(driver_r2.name);\n  }\n}\nfunction TrackingViewComponent_div_10_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 16);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" Rastreando ubicaci\\u00F3n de \", ctx_r2.getSelectedDriverName(), \" - Actualizaci\\u00F3n cada 5 segundos \");\n  }\n}\nfunction TrackingViewComponent_div_11_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 17);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.trackingError, \" \");\n  }\n}\nfunction TrackingViewComponent_div_14_p_20_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\")(1, \"strong\");\n    i0.ɵɵtext(2, \"Direcci\\u00F3n actual:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(3);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.currentAddress.label, \"\");\n  }\n}\nfunction TrackingViewComponent_div_14_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 18)(1, \"h3\");\n    i0.ɵɵtext(2, \"Ubicaci\\u00F3n Actual\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"p\")(4, \"strong\");\n    i0.ɵɵtext(5, \"Conductor:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(6);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(7, \"p\")(8, \"strong\");\n    i0.ɵɵtext(9, \"Coordenadas:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(10);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(11, \"p\")(12, \"strong\");\n    i0.ɵɵtext(13, \"Velocidad:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(14);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(15, \"p\")(16, \"strong\");\n    i0.ɵɵtext(17, \"\\u00DAltima actualizaci\\u00F3n:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(18);\n    i0.ɵɵpipe(19, \"date\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(20, TrackingViewComponent_div_14_p_20_Template, 4, 1, \"p\", 19);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(6);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.getSelectedDriverName(), \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate2(\" \", ctx_r2.currentLocation.coordinates.lat, \", \", ctx_r2.currentLocation.coordinates.lng, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.currentLocation.speed || 0, \" km/h\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", i0.ɵɵpipeBind2(19, 6, ctx_r2.currentLocation.timestamp, \"medium\"), \"\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.currentAddress);\n  }\n}\nfunction TrackingViewComponent_div_15_div_3_span_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\", 27);\n    i0.ɵɵtext(1, \"\\u2713 Completado\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction TrackingViewComponent_div_15_div_3_span_9_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\", 28);\n    i0.ɵɵtext(1, \"\\uD83D\\uDCCD Ubicaci\\u00F3n Actual\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction TrackingViewComponent_div_15_div_3_span_10_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\", 23);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const address_r4 = i0.ɵɵnextContext().$implicit;\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" Distancia: \", ctx_r2.getDistanceToAddress(address_r4), \"m \");\n  }\n}\nfunction TrackingViewComponent_div_15_div_3_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 21)(1, \"div\", 22)(2, \"div\")(3, \"strong\");\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(5, \"div\", 23);\n    i0.ɵɵtext(6);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(7, \"div\");\n    i0.ɵɵtemplate(8, TrackingViewComponent_div_15_div_3_span_8_Template, 2, 0, \"span\", 24)(9, TrackingViewComponent_div_15_div_3_span_9_Template, 2, 0, \"span\", 25)(10, TrackingViewComponent_div_15_div_3_span_10_Template, 2, 1, \"span\", 26);\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const address_r4 = ctx.$implicit;\n    const i_r5 = ctx.index;\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵclassProp(\"completed\", ctx_r2.isAddressCompleted(address_r4));\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate2(\"\", i_r5 + 1, \". \", address_r4.label, \"\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate2(\" \", address_r4.coordinates.lat, \", \", address_r4.coordinates.lng, \" \");\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.isAddressCompleted(address_r4));\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.isCurrentDeliveryPoint(address_r4));\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.getDistanceToAddress(address_r4) !== null);\n  }\n}\nfunction TrackingViewComponent_div_15_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 1)(1, \"h3\");\n    i0.ɵɵtext(2, \"Puntos de Entrega\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(3, TrackingViewComponent_div_15_div_3_Template, 11, 9, \"div\", 20);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r2.savedAddresses);\n  }\n}\nexport let TrackingViewComponent = /*#__PURE__*/(() => {\n  class TrackingViewComponent {\n    constructor(hereMapsService, addressService, http) {\n      this.hereMapsService = hereMapsService;\n      this.addressService = addressService;\n      this.http = http;\n      this.selectedDriverId = '';\n      this.drivers = [{\n        id: 'driver1',\n        name: 'Juan Pérez'\n      }, {\n        id: 'driver2',\n        name: 'María González'\n      }, {\n        id: 'driver3',\n        name: 'Carlos López'\n      }];\n      this.trackingActive = false;\n      this.trackingError = '';\n      this.currentLocation = null;\n      this.currentAddress = null;\n      this.savedAddresses = [];\n      this.completedAddresses = new Set();\n      this.routeMarkers = [];\n      this.trackingSubscription = null;\n      this.locationSubscription = null;\n    }\n    ngOnInit() {\n      this.addressService.addresses$.subscribe(addresses => {\n        this.savedAddresses = addresses;\n        this.updateRouteMarkers();\n      });\n      this.locationSubscription = this.hereMapsService.currentLocation$.subscribe(location => {\n        if (location) {\n          this.currentLocation = location;\n          this.updateCurrentLocationOnMap();\n          this.checkProximityToDeliveryPoints();\n        }\n      });\n    }\n    ngAfterViewInit() {\n      this.initializeMap();\n    }\n    ngOnDestroy() {\n      this.stopTracking();\n      if (this.locationSubscription) {\n        this.locationSubscription.unsubscribe();\n      }\n    }\n    initializeMap() {\n      const defaultCenter = {\n        lat: 19.4326,\n        lng: -99.1332\n      };\n      const mapInstance = this.hereMapsService.createMap(this.trackingMapContainer.nativeElement, defaultCenter, 12);\n      this.map = mapInstance.map;\n      this.ui = mapInstance.ui;\n      this.behavior = mapInstance.behavior;\n      this.updateRouteMarkers();\n    }\n    onDriverChange() {\n      if (this.trackingActive) {\n        this.stopTracking();\n      }\n      this.currentLocation = null;\n      this.currentAddress = null;\n      this.trackingError = '';\n    }\n    startTracking() {\n      if (!this.selectedDriverId) {\n        this.trackingError = 'Selecciona un conductor primero';\n        return;\n      }\n      this.trackingActive = true;\n      this.trackingError = '';\n      this.trackingSubscription = interval(5000).subscribe(() => {\n        this.fetchLocationUpdate();\n      });\n      this.fetchLocationUpdate();\n    }\n    stopTracking() {\n      this.trackingActive = false;\n      if (this.trackingSubscription) {\n        this.trackingSubscription.unsubscribe();\n        this.trackingSubscription = null;\n      }\n    }\n    fetchLocationUpdate() {\n      this.http.get(`http://localhost:3000/api/location/${this.selectedDriverId}`).subscribe({\n        next: location => {\n          this.hereMapsService.updateLocation(location);\n          this.updateCurrentAddress(location.coordinates);\n        },\n        error: error => {\n          this.trackingError = 'Error al obtener la ubicación del conductor';\n        }\n      });\n    }\n    updateCurrentAddress(coordinates) {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        try {\n          const address = yield _this.hereMapsService.reverseGeocode(coordinates.lat, coordinates.lng);\n          _this.currentAddress = address;\n        } catch (error) {\n          _this.currentAddress = null;\n        }\n      })();\n    }\n    updateCurrentLocationOnMap() {\n      if (!this.currentLocation) return;\n      if (this.currentMarker) {\n        this.map.removeObject(this.currentMarker);\n      }\n      const icon = new H.map.Icon('data:image/svg+xml;base64,' + btoa(`\n        <svg width=\"32\" height=\"32\" xmlns=\"http://www.w3.org/2000/svg\">\n          <circle cx=\"16\" cy=\"16\" r=\"12\" fill=\"blue\" stroke=\"white\" stroke-width=\"3\"/>\n          <circle cx=\"16\" cy=\"16\" r=\"6\" fill=\"white\"/>\n        </svg>\n      `), {\n        size: {\n          w: 32,\n          h: 32\n        }\n      });\n      this.currentMarker = this.hereMapsService.addMarker(this.map, this.currentLocation.coordinates, {\n        icon\n      });\n      this.map.setCenter(this.currentLocation.coordinates);\n    }\n    updateRouteMarkers() {\n      this.routeMarkers.forEach(marker => {\n        this.map.removeObject(marker);\n      });\n      this.routeMarkers = [];\n      this.savedAddresses.forEach((address, index) => {\n        const icon = new H.map.Icon('data:image/svg+xml;base64,' + btoa(`\n          <svg width=\"32\" height=\"32\" xmlns=\"http://www.w3.org/2000/svg\">\n            <circle cx=\"16\" cy=\"16\" r=\"12\" fill=\"${this.isAddressCompleted(address) ? 'green' : 'red'}\" stroke=\"white\" stroke-width=\"3\"/>\n            <text x=\"16\" y=\"20\" text-anchor=\"middle\" fill=\"white\" font-size=\"14\" font-weight=\"bold\">${index + 1}</text>\n          </svg>\n        `), {\n          size: {\n            w: 32,\n            h: 32\n          }\n        });\n        const marker = this.hereMapsService.addMarker(this.map, address.coordinates, {\n          icon\n        });\n        this.routeMarkers.push(marker);\n      });\n    }\n    checkProximityToDeliveryPoints() {\n      if (!this.currentLocation) return;\n      this.savedAddresses.forEach(address => {\n        const distance = this.calculateDistance(this.currentLocation.coordinates, address.coordinates);\n        if (distance < 100 && !this.completedAddresses.has(address.id)) {\n          this.completedAddresses.add(address.id);\n          this.updateRouteMarkers();\n        }\n      });\n    }\n    getSelectedDriverName() {\n      const driver = this.drivers.find(d => d.id === this.selectedDriverId);\n      return driver ? driver.name : '';\n    }\n    isAddressCompleted(address) {\n      return this.completedAddresses.has(address.id);\n    }\n    isCurrentDeliveryPoint(address) {\n      if (!this.currentLocation) return false;\n      const distance = this.calculateDistance(this.currentLocation.coordinates, address.coordinates);\n      return distance < 100;\n    }\n    getDistanceToAddress(address) {\n      if (!this.currentLocation) return null;\n      return Math.round(this.calculateDistance(this.currentLocation.coordinates, address.coordinates));\n    }\n    calculateDistance(coord1, coord2) {\n      const R = 6371e3;\n      const φ1 = coord1.lat * Math.PI / 180;\n      const φ2 = coord2.lat * Math.PI / 180;\n      const Δφ = (coord2.lat - coord1.lat) * Math.PI / 180;\n      const Δλ = (coord2.lng - coord1.lng) * Math.PI / 180;\n      const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);\n      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n      return R * c;\n    }\n    static {\n      this.ɵfac = function TrackingViewComponent_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || TrackingViewComponent)(i0.ɵɵdirectiveInject(i1.HereMapsService), i0.ɵɵdirectiveInject(i2.AddressService), i0.ɵɵdirectiveInject(i3.HttpClient));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: TrackingViewComponent,\n        selectors: [[\"app-tracking-view\"]],\n        viewQuery: function TrackingViewComponent_Query(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵviewQuery(_c0, 7);\n          }\n          if (rf & 2) {\n            let _t;\n            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.trackingMapContainer = _t.first);\n          }\n        },\n        standalone: true,\n        features: [i0.ɵɵStandaloneFeature],\n        decls: 21,\n        vars: 8,\n        consts: [[\"trackingMap\", \"\"], [1, \"card\"], [1, \"form-group\"], [\"for\", \"driverSelect\"], [\"id\", \"driverSelect\", 1, \"form-control\", 3, \"ngModelChange\", \"change\", \"ngModel\"], [\"value\", \"\"], [3, \"value\", 4, \"ngFor\", \"ngForOf\"], [\"class\", \"alert alert-success\", 4, \"ngIf\"], [\"class\", \"alert alert-error\", 4, \"ngIf\"], [1, \"map-container\", 2, \"height\", \"500px\"], [\"class\", \"card\", \"style\", \"margin-top: 20px;\", 4, \"ngIf\"], [\"class\", \"card\", 4, \"ngIf\"], [1, \"form-group\", 2, \"margin-top\", \"20px\"], [1, \"btn\", \"btn-primary\", 3, \"click\", \"disabled\"], [1, \"btn\", \"btn-primary\", 2, \"margin-left\", \"10px\", 3, \"click\", \"disabled\"], [3, \"value\"], [1, \"alert\", \"alert-success\"], [1, \"alert\", \"alert-error\"], [1, \"card\", 2, \"margin-top\", \"20px\"], [4, \"ngIf\"], [\"class\", \"delivery-point\", \"style\", \"padding: 10px; border: 1px solid #ddd; margin: 5px 0; border-radius: 4px;\", 3, \"completed\", 4, \"ngFor\", \"ngForOf\"], [1, \"delivery-point\", 2, \"padding\", \"10px\", \"border\", \"1px solid #ddd\", \"margin\", \"5px 0\", \"border-radius\", \"4px\"], [2, \"display\", \"flex\", \"justify-content\", \"space-between\", \"align-items\", \"center\"], [2, \"font-size\", \"12px\", \"color\", \"#666\"], [\"style\", \"color: green; font-weight: bold;\", 4, \"ngIf\"], [\"style\", \"color: orange; font-weight: bold;\", 4, \"ngIf\"], [\"style\", \"font-size: 12px; color: #666;\", 4, \"ngIf\"], [2, \"color\", \"green\", \"font-weight\", \"bold\"], [2, \"color\", \"orange\", \"font-weight\", \"bold\"]],\n        template: function TrackingViewComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            const _r1 = i0.ɵɵgetCurrentView();\n            i0.ɵɵelementStart(0, \"div\", 1)(1, \"h2\");\n            i0.ɵɵtext(2, \"Rastreo en Tiempo Real\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(3, \"div\", 2)(4, \"label\", 3);\n            i0.ɵɵtext(5, \"Seleccionar conductor:\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(6, \"select\", 4);\n            i0.ɵɵtwoWayListener(\"ngModelChange\", function TrackingViewComponent_Template_select_ngModelChange_6_listener($event) {\n              i0.ɵɵrestoreView(_r1);\n              i0.ɵɵtwoWayBindingSet(ctx.selectedDriverId, $event) || (ctx.selectedDriverId = $event);\n              return i0.ɵɵresetView($event);\n            });\n            i0.ɵɵlistener(\"change\", function TrackingViewComponent_Template_select_change_6_listener() {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.onDriverChange());\n            });\n            i0.ɵɵelementStart(7, \"option\", 5);\n            i0.ɵɵtext(8, \"Selecciona un conductor\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵtemplate(9, TrackingViewComponent_option_9_Template, 2, 2, \"option\", 6);\n            i0.ɵɵelementEnd()();\n            i0.ɵɵtemplate(10, TrackingViewComponent_div_10_Template, 2, 1, \"div\", 7)(11, TrackingViewComponent_div_11_Template, 2, 1, \"div\", 8);\n            i0.ɵɵelement(12, \"div\", 9, 0);\n            i0.ɵɵtemplate(14, TrackingViewComponent_div_14_Template, 21, 9, \"div\", 10)(15, TrackingViewComponent_div_15_Template, 4, 1, \"div\", 11);\n            i0.ɵɵelementStart(16, \"div\", 12)(17, \"button\", 13);\n            i0.ɵɵlistener(\"click\", function TrackingViewComponent_Template_button_click_17_listener() {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.startTracking());\n            });\n            i0.ɵɵtext(18, \" Iniciar Rastreo \");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(19, \"button\", 14);\n            i0.ɵɵlistener(\"click\", function TrackingViewComponent_Template_button_click_19_listener() {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.stopTracking());\n            });\n            i0.ɵɵtext(20, \" Detener Rastreo \");\n            i0.ɵɵelementEnd()()();\n          }\n          if (rf & 2) {\n            i0.ɵɵadvance(6);\n            i0.ɵɵtwoWayProperty(\"ngModel\", ctx.selectedDriverId);\n            i0.ɵɵadvance(3);\n            i0.ɵɵproperty(\"ngForOf\", ctx.drivers);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.trackingActive);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.trackingError);\n            i0.ɵɵadvance(3);\n            i0.ɵɵproperty(\"ngIf\", ctx.currentLocation);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.savedAddresses.length > 0);\n            i0.ɵɵadvance(2);\n            i0.ɵɵproperty(\"disabled\", !ctx.selectedDriverId || ctx.trackingActive);\n            i0.ɵɵadvance(2);\n            i0.ɵɵproperty(\"disabled\", !ctx.trackingActive);\n          }\n        },\n        dependencies: [CommonModule, i4.NgForOf, i4.NgIf, i4.DatePipe, FormsModule, i5.NgSelectOption, i5.ɵNgSelectMultipleOption, i5.SelectControlValueAccessor, i5.NgControlStatus, i5.NgModel],\n        styles: [\".delivery-point.completed[_ngcontent-%COMP%]{background-color:#d4edda;border-color:#c3e6cb}\"]\n      });\n    }\n  }\n  return TrackingViewComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}