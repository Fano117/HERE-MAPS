{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/Alfredo/Documents/HERE-MAPS/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { interval } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../../services/here-maps.service\";\nimport * as i2 from \"../../services/address.service\";\nimport * as i3 from \"@angular/common/http\";\nimport * as i4 from \"@angular/common\";\nimport * as i5 from \"@angular/forms\";\nconst _c0 = [\"trackingMap\"];\nfunction TrackingViewComponent_option_9_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"option\", 17);\n    i0.…µ…µtext(1);\n    i0.…µ…µelementEnd();\n  }\n  if (rf & 2) {\n    const driver_r2 = ctx.$implicit;\n    i0.…µ…µproperty(\"value\", driver_r2.id);\n    i0.…µ…µadvance();\n    i0.…µ…µtextInterpolate(driver_r2.name);\n  }\n}\nfunction TrackingViewComponent_div_10_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"div\", 18);\n    i0.…µ…µtext(1);\n    i0.…µ…µelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.…µ…µnextContext();\n    i0.…µ…µadvance();\n    i0.…µ…µtextInterpolate1(\" Rastreando ubicaci\\u00F3n de \", ctx_r2.getSelectedDriverName(), \" - Actualizaci\\u00F3n cada 5 segundos \");\n  }\n}\nfunction TrackingViewComponent_div_11_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"div\", 19);\n    i0.…µ…µtext(1);\n    i0.…µ…µelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.…µ…µnextContext();\n    i0.…µ…µadvance();\n    i0.…µ…µtextInterpolate1(\" \", ctx_r2.trackingError, \" \");\n  }\n}\nfunction TrackingViewComponent_div_14_p_20_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"p\")(1, \"strong\");\n    i0.…µ…µtext(2, \"Direcci\\u00F3n actual:\");\n    i0.…µ…µelementEnd();\n    i0.…µ…µtext(3);\n    i0.…µ…µelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.…µ…µnextContext(2);\n    i0.…µ…µadvance(3);\n    i0.…µ…µtextInterpolate1(\" \", ctx_r2.currentAddress.label, \"\");\n  }\n}\nfunction TrackingViewComponent_div_14_div_21_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"div\", 23)(1, \"h4\");\n    i0.…µ…µtext(2, \"Ruta Actual\");\n    i0.…µ…µelementEnd();\n    i0.…µ…µelementStart(3, \"p\")(4, \"strong\");\n    i0.…µ…µtext(5, \"Distancia total:\");\n    i0.…µ…µelementEnd();\n    i0.…µ…µtext(6);\n    i0.…µ…µelementEnd();\n    i0.…µ…µelementStart(7, \"p\")(8, \"strong\");\n    i0.…µ…µtext(9, \"Tiempo estimado:\");\n    i0.…µ…µelementEnd();\n    i0.…µ…µtext(10);\n    i0.…µ…µelementEnd();\n    i0.…µ…µelementStart(11, \"p\")(12, \"strong\");\n    i0.…µ…µtext(13, \"Entregas completadas:\");\n    i0.…µ…µelementEnd();\n    i0.…µ…µtext(14);\n    i0.…µ…µelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.…µ…µnextContext(2);\n    i0.…µ…µadvance(6);\n    i0.…µ…µtextInterpolate1(\" \", ctx_r2.currentRoute.totalDistance, \" km\");\n    i0.…µ…µadvance(4);\n    i0.…µ…µtextInterpolate1(\" \", ctx_r2.currentRoute.estimatedTime, \" minutos\");\n    i0.…µ…µadvance(4);\n    i0.…µ…µtextInterpolate2(\" \", ctx_r2.currentRoute.completedDeliveries, \" / \", ctx_r2.currentRoute.totalDeliveries, \"\");\n  }\n}\nfunction TrackingViewComponent_div_14_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"div\", 20)(1, \"h3\");\n    i0.…µ…µtext(2, \"Ubicaci\\u00F3n del Conductor\");\n    i0.…µ…µelementEnd();\n    i0.…µ…µelementStart(3, \"p\")(4, \"strong\");\n    i0.…µ…µtext(5, \"Conductor:\");\n    i0.…µ…µelementEnd();\n    i0.…µ…µtext(6);\n    i0.…µ…µelementEnd();\n    i0.…µ…µelementStart(7, \"p\")(8, \"strong\");\n    i0.…µ…µtext(9, \"Coordenadas:\");\n    i0.…µ…µelementEnd();\n    i0.…µ…µtext(10);\n    i0.…µ…µelementEnd();\n    i0.…µ…µelementStart(11, \"p\")(12, \"strong\");\n    i0.…µ…µtext(13, \"Velocidad:\");\n    i0.…µ…µelementEnd();\n    i0.…µ…µtext(14);\n    i0.…µ…µelementEnd();\n    i0.…µ…µelementStart(15, \"p\")(16, \"strong\");\n    i0.…µ…µtext(17, \"\\u00DAltima actualizaci\\u00F3n:\");\n    i0.…µ…µelementEnd();\n    i0.…µ…µtext(18);\n    i0.…µ…µpipe(19, \"date\");\n    i0.…µ…µelementEnd();\n    i0.…µ…µtemplate(20, TrackingViewComponent_div_14_p_20_Template, 4, 1, \"p\", 21)(21, TrackingViewComponent_div_14_div_21_Template, 15, 4, \"div\", 22);\n    i0.…µ…µelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.…µ…µnextContext();\n    i0.…µ…µadvance(6);\n    i0.…µ…µtextInterpolate1(\" \", ctx_r2.getSelectedDriverName(), \"\");\n    i0.…µ…µadvance(4);\n    i0.…µ…µtextInterpolate2(\" \", ctx_r2.currentLocation.coordinates.lat, \", \", ctx_r2.currentLocation.coordinates.lng, \"\");\n    i0.…µ…µadvance(4);\n    i0.…µ…µtextInterpolate1(\" \", ctx_r2.currentLocation.speed || 0, \" km/h\");\n    i0.…µ…µadvance(4);\n    i0.…µ…µtextInterpolate1(\" \", i0.…µ…µpipeBind2(19, 7, ctx_r2.currentLocation.timestamp, \"medium\"), \"\");\n    i0.…µ…µadvance(2);\n    i0.…µ…µproperty(\"ngIf\", ctx_r2.currentAddress);\n    i0.…µ…µadvance();\n    i0.…µ…µproperty(\"ngIf\", ctx_r2.currentRoute);\n  }\n}\nfunction TrackingViewComponent_div_15_div_3_span_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"span\", 31);\n    i0.…µ…µtext(1, \"\\u2713 Completado\");\n    i0.…µ…µelementEnd();\n  }\n}\nfunction TrackingViewComponent_div_15_div_3_span_9_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"span\", 32);\n    i0.…µ…µtext(1, \"\\uD83D\\uDCCD Ubicaci\\u00F3n Actual\");\n    i0.…µ…µelementEnd();\n  }\n}\nfunction TrackingViewComponent_div_15_div_3_span_10_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"span\", 27);\n    i0.…µ…µtext(1);\n    i0.…µ…µelementEnd();\n  }\n  if (rf & 2) {\n    const address_r4 = i0.…µ…µnextContext().$implicit;\n    const ctx_r2 = i0.…µ…µnextContext(2);\n    i0.…µ…µadvance();\n    i0.…µ…µtextInterpolate1(\" Distancia: \", ctx_r2.getDistanceToAddress(address_r4), \"m \");\n  }\n}\nfunction TrackingViewComponent_div_15_div_3_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"div\", 25)(1, \"div\", 26)(2, \"div\")(3, \"strong\");\n    i0.…µ…µtext(4);\n    i0.…µ…µelementEnd();\n    i0.…µ…µelementStart(5, \"div\", 27);\n    i0.…µ…µtext(6);\n    i0.…µ…µelementEnd()();\n    i0.…µ…µelementStart(7, \"div\");\n    i0.…µ…µtemplate(8, TrackingViewComponent_div_15_div_3_span_8_Template, 2, 0, \"span\", 28)(9, TrackingViewComponent_div_15_div_3_span_9_Template, 2, 0, \"span\", 29)(10, TrackingViewComponent_div_15_div_3_span_10_Template, 2, 1, \"span\", 30);\n    i0.…µ…µelementEnd()()();\n  }\n  if (rf & 2) {\n    const address_r4 = ctx.$implicit;\n    const i_r5 = ctx.index;\n    const ctx_r2 = i0.…µ…µnextContext(2);\n    i0.…µ…µclassProp(\"completed\", ctx_r2.isAddressCompleted(address_r4));\n    i0.…µ…µadvance(4);\n    i0.…µ…µtextInterpolate2(\"\", i_r5 + 1, \". \", address_r4.label, \"\");\n    i0.…µ…µadvance(2);\n    i0.…µ…µtextInterpolate2(\" \", address_r4.coordinates.lat, \", \", address_r4.coordinates.lng, \" \");\n    i0.…µ…µadvance(2);\n    i0.…µ…µproperty(\"ngIf\", ctx_r2.isAddressCompleted(address_r4));\n    i0.…µ…µadvance();\n    i0.…µ…µproperty(\"ngIf\", ctx_r2.isCurrentDeliveryPoint(address_r4));\n    i0.…µ…µadvance();\n    i0.…µ…µproperty(\"ngIf\", ctx_r2.getDistanceToAddress(address_r4) !== null);\n  }\n}\nfunction TrackingViewComponent_div_15_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.…µ…µelementStart(0, \"div\", 1)(1, \"h3\");\n    i0.…µ…µtext(2, \"Puntos de Entrega\");\n    i0.…µ…µelementEnd();\n    i0.…µ…µtemplate(3, TrackingViewComponent_div_15_div_3_Template, 11, 9, \"div\", 24);\n    i0.…µ…µelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.…µ…µnextContext();\n    i0.…µ…µadvance(3);\n    i0.…µ…µproperty(\"ngForOf\", ctx_r2.savedAddresses);\n  }\n}\nexport let TrackingViewComponent = /*#__PURE__*/(() => {\n  class TrackingViewComponent {\n    constructor(hereMapsService, addressService, http) {\n      this.hereMapsService = hereMapsService;\n      this.addressService = addressService;\n      this.http = http;\n      this.selectedDriverId = '';\n      this.drivers = [{\n        id: 'driver1',\n        name: 'Juan P√©rez'\n      }, {\n        id: 'driver2',\n        name: 'Mar√≠a Gonz√°lez'\n      }, {\n        id: 'driver3',\n        name: 'Carlos L√≥pez'\n      }];\n      this.trackingActive = false;\n      this.trackingError = '';\n      this.currentLocation = null;\n      this.currentAddress = null;\n      this.savedAddresses = [];\n      this.completedAddresses = new Set();\n      this.currentRoute = null;\n      this.routeMarkers = [];\n      this.routeLines = [];\n      this.optimizedRoute = null;\n      this.trackingSubscription = null;\n      this.locationSubscription = null;\n    }\n    ngOnInit() {\n      console.log('TrackingViewComponent cargado con funcionalidad de rutas');\n      this.addressService.addresses$.subscribe(addresses => {\n        this.savedAddresses = addresses;\n        console.log('Direcciones cargadas en tracking:', addresses.length);\n        this.updateRouteMarkers();\n      });\n      this.locationSubscription = this.hereMapsService.currentLocation$.subscribe(location => {\n        if (location) {\n          this.currentLocation = location;\n          this.updateCurrentLocationOnMap();\n          this.checkProximityToDeliveryPoints();\n        }\n      });\n    }\n    ngAfterViewInit() {\n      setTimeout(() => {\n        this.initializeMap();\n      }, 500);\n    }\n    ngOnDestroy() {\n      this.stopTracking();\n      if (this.locationSubscription) {\n        this.locationSubscription.unsubscribe();\n      }\n    }\n    initializeMap() {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        if (!_this.trackingMapContainer?.nativeElement) {\n          _this.trackingError = 'Container del mapa no disponible';\n          setTimeout(() => _this.initializeMap(), 1000);\n          return;\n        }\n        const defaultCenter = {\n          lat: 19.4326,\n          lng: -99.1332\n        };\n        try {\n          const mapInstance = yield _this.hereMapsService.createMap(_this.trackingMapContainer.nativeElement, defaultCenter, 12);\n          _this.map = mapInstance.map;\n          _this.ui = mapInstance.ui;\n          _this.behavior = mapInstance.behavior;\n          _this.updateRouteMarkers();\n          _this.trackingError = '';\n        } catch (error) {\n          _this.trackingError = `Error al inicializar el mapa: ${error}`;\n          setTimeout(() => _this.initializeMap(), 2000);\n        }\n      })();\n    }\n    onDriverChange() {\n      if (this.trackingActive) {\n        this.stopTracking();\n      }\n      this.currentLocation = null;\n      this.currentAddress = null;\n      this.trackingError = '';\n      this.clearRouteLines();\n    }\n    startTracking() {\n      if (!this.selectedDriverId) {\n        this.trackingError = 'Selecciona un conductor primero';\n        return;\n      }\n      this.trackingActive = true;\n      this.trackingError = '';\n      this.startSimulation();\n      this.trackingSubscription = interval(5000).subscribe(() => {\n        this.fetchLocationUpdate();\n      });\n      this.fetchLocationUpdate();\n    }\n    stopTracking() {\n      this.trackingActive = false;\n      this.stopSimulation();\n      if (this.trackingSubscription) {\n        this.trackingSubscription.unsubscribe();\n        this.trackingSubscription = null;\n      }\n      this.clearRouteLines();\n    }\n    calculateAndShowRoute() {\n      var _this2 = this;\n      return _asyncToGenerator(function* () {\n        if (!_this2.map || !_this2.currentLocation || _this2.savedAddresses.length === 0) {\n          _this2.trackingError = 'No se puede calcular la ruta. Aseg√∫rate de que haya puntos de entrega y ubicaci√≥n actual.';\n          return;\n        }\n        _this2.trackingError = '';\n        try {\n          // Filtrar direcciones no completadas\n          const pendingAddresses = _this2.savedAddresses.filter(addr => !_this2.isAddressCompleted(addr));\n          if (pendingAddresses.length === 0) {\n            _this2.trackingError = 'No hay entregas pendientes para mostrar ruta.';\n            return;\n          }\n          const startPoint = _this2.currentLocation.coordinates;\n          const waypoints = pendingAddresses.map(addr => addr.coordinates);\n          _this2.optimizedRoute = yield _this2.hereMapsService.calculateOptimizedRoute(startPoint, waypoints);\n          if (_this2.optimizedRoute) {\n            _this2.clearRouteLines();\n            _this2.drawRouteLines();\n            _this2.updateRouteMarkers(); // Actualizar marcadores despu√©s de mostrar la ruta\n            _this2.trackingError = '';\n          } else {\n            _this2.trackingError = 'No se pudo calcular la ruta optimizada.';\n          }\n        } catch (error) {\n          console.error('Error calculando ruta en tracking:', error);\n          _this2.trackingError = 'Error al calcular la ruta optimizada.';\n        }\n      })();\n    }\n    drawRouteLines() {\n      if (!this.map || !this.optimizedRoute?.sections || !Array.isArray(this.optimizedRoute.sections)) {\n        return;\n      }\n      this.optimizedRoute.sections.forEach((section, index) => {\n        if (!section) return;\n        try {\n          let lineString = new H.geo.LineString();\n          if (section.type === 'manual' && section.departure && section.arrival) {\n            const departure = section.departure;\n            const arrival = section.arrival;\n            if (this.hereMapsService.validateCoordinates(departure) && this.hereMapsService.validateCoordinates(arrival)) {\n              lineString.pushPoint(departure.lat, departure.lng);\n              lineString.pushPoint(arrival.lat, arrival.lng);\n            } else {\n              return;\n            }\n          } else if (section.polyline && typeof section.polyline === 'string') {\n            try {\n              lineString = H.geo.LineString.fromFlexiblePolyline(section.polyline);\n            } catch (decodeError) {\n              const routeCoordinates = this.hereMapsService.decodePolyline(section.polyline);\n              if (!Array.isArray(routeCoordinates) || routeCoordinates.length === 0) {\n                return;\n              }\n              let validPointsAdded = 0;\n              routeCoordinates.forEach(coord => {\n                if (coord && typeof coord.lat === 'number' && typeof coord.lng === 'number' && !isNaN(coord.lat) && !isNaN(coord.lng)) {\n                  lineString.pushPoint(coord.lat, coord.lng);\n                  validPointsAdded++;\n                }\n              });\n              if (validPointsAdded < 2) {\n                return;\n              }\n            }\n          } else {\n            return;\n          }\n          const routeLine = new H.map.Polyline(lineString, {\n            style: {\n              strokeColor: index === this.optimizedRoute.sections.length - 1 ? '#ff6b35' : '#1e90ff',\n              lineWidth: 4,\n              lineDash: [0],\n              lineCap: 'round'\n            }\n          });\n          this.routeLines.push(routeLine);\n          this.map.addObject(routeLine);\n        } catch (error) {\n          console.warn('Error al procesar secci√≥n de ruta en tracking:', error);\n        }\n      });\n    }\n    clearRouteLines() {\n      if (!this.map) return;\n      this.routeLines.forEach(line => {\n        try {\n          this.map.removeObject(line);\n        } catch (error) {\n          console.warn('Error removiendo l√≠nea de ruta:', error);\n        }\n      });\n      this.routeLines = [];\n    }\n    fetchLocationUpdate() {\n      this.http.get(`http://localhost:3000/api/location/${this.selectedDriverId}`).subscribe({\n        next: location => {\n          this.currentLocation = location;\n          this.hereMapsService.updateLocation(location);\n          this.updateCurrentAddress(location.coordinates);\n          this.updateCurrentRoute();\n        },\n        error: error => {\n          this.trackingError = 'Error al obtener la ubicaci√≥n del conductor';\n        }\n      });\n    }\n    updateCurrentAddress(coordinates) {\n      var _this3 = this;\n      return _asyncToGenerator(function* () {\n        try {\n          const address = yield _this3.hereMapsService.reverseGeocode(coordinates.lat, coordinates.lng);\n          _this3.currentAddress = address;\n        } catch (error) {\n          _this3.currentAddress = null;\n        }\n      })();\n    }\n    updateCurrentRoute() {\n      if (!this.savedAddresses.length || !this.currentLocation) return;\n      const totalDeliveries = this.savedAddresses.length;\n      const completedDeliveries = this.getCompletedDeliveryCount();\n      const totalDistance = this.calculateTotalRouteDistance();\n      const estimatedTime = this.calculateEstimatedTime();\n      this.currentRoute = {\n        totalDistance: totalDistance,\n        estimatedTime: estimatedTime,\n        completedDeliveries: completedDeliveries,\n        totalDeliveries: totalDeliveries,\n        progress: Math.round(completedDeliveries / totalDeliveries * 100)\n      };\n    }\n    getCompletedDeliveryCount() {\n      return this.savedAddresses.filter(addr => this.isAddressCompleted(addr)).length;\n    }\n    calculateTotalRouteDistance() {\n      if (!this.savedAddresses.length || !this.currentLocation) return 0;\n      let totalDistance = 0;\n      let currentPoint = this.currentLocation.coordinates;\n      for (const address of this.savedAddresses) {\n        if (!this.isAddressCompleted(address)) {\n          const distance = this.calculateDistance(currentPoint, address.coordinates);\n          totalDistance += distance;\n          currentPoint = address.coordinates;\n        }\n      }\n      return Math.round(totalDistance / 1000 * 100) / 100;\n    }\n    calculateEstimatedTime() {\n      if (!this.savedAddresses.length) return 0;\n      const remainingDeliveries = this.savedAddresses.filter(addr => !this.isAddressCompleted(addr)).length;\n      const avgTimePerDelivery = 15;\n      const travelTime = this.calculateTotalRouteDistance() / 50 * 60;\n      return Math.round(remainingDeliveries * avgTimePerDelivery + travelTime);\n    }\n    calculateDistance(coord1, coord2) {\n      const R = 6371000;\n      const œÜ1 = coord1.lat * Math.PI / 180;\n      const œÜ2 = coord2.lat * Math.PI / 180;\n      const ŒîœÜ = (coord2.lat - coord1.lat) * Math.PI / 180;\n      const ŒîŒª = (coord2.lng - coord1.lng) * Math.PI / 180;\n      const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);\n      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n      return R * c;\n    }\n    updateCurrentLocationOnMap() {\n      if (!this.currentLocation || !this.map) return;\n      if (this.currentMarker) {\n        this.hereMapsService.removeMarkerSafely(this.map, this.currentMarker);\n      }\n      const icon = new H.map.Icon('data:image/svg+xml;base64,' + btoa(`\n        <svg width=\"32\" height=\"32\" xmlns=\"http://www.w3.org/2000/svg\">\n          <circle cx=\"16\" cy=\"16\" r=\"12\" fill=\"blue\" stroke=\"white\" stroke-width=\"3\"/>\n          <circle cx=\"16\" cy=\"16\" r=\"6\" fill=\"white\"/>\n        </svg>\n      `), {\n        size: {\n          w: 32,\n          h: 32\n        }\n      });\n      this.currentMarker = this.hereMapsService.addMarker(this.map, this.currentLocation.coordinates, {\n        icon\n      });\n      this.map.setCenter(this.currentLocation.coordinates);\n    }\n    updateRouteMarkers() {\n      if (!this.map) return;\n      // Limpiar marcadores existentes\n      this.routeMarkers.forEach(marker => {\n        this.hereMapsService.removeMarkerSafely(this.map, marker);\n      });\n      this.routeMarkers = [];\n      // Agregar marcador de inicio (ubicaci√≥n del conductor)\n      if (this.currentLocation) {\n        const startIcon = new H.map.Icon('data:image/svg+xml;base64=' + btoa(`\n          <svg width=\"36\" height=\"36\" xmlns=\"http://www.w3.org/2000/svg\">\n            <circle cx=\"18\" cy=\"18\" r=\"15\" fill=\"blue\" stroke=\"white\" stroke-width=\"4\"/>\n            <text x=\"18\" y=\"23\" text-anchor=\"middle\" fill=\"white\" font-size=\"16\" font-weight=\"bold\">S</text>\n          </svg>\n        `), {\n          size: {\n            w: 36,\n            h: 36\n          }\n        });\n        const startMarker = this.hereMapsService.addMarker(this.map, this.currentLocation.coordinates, {\n          icon: startIcon\n        });\n        this.routeMarkers.push(startMarker);\n      }\n      // Agregar marcadores para cada direcci√≥n\n      this.savedAddresses.forEach((address, index) => {\n        const isCompleted = this.isAddressCompleted(address);\n        const isPending = !isCompleted;\n        const icon = new H.map.Icon('data:image/svg+xml;base64=' + btoa(`\n          <svg width=\"36\" height=\"36\" xmlns=\"http://www.w3.org/2000/svg\">\n            <circle cx=\"18\" cy=\"18\" r=\"15\" fill=\"${isCompleted ? '#28a745' : '#dc3545'}\" stroke=\"white\" stroke-width=\"4\"/>\n            ${isCompleted ? '<text x=\"18\" y=\"24\" text-anchor=\"middle\" fill=\"white\" font-size=\"20\" font-weight=\"bold\">‚úì</text>' : `<text x=\"18\" y=\"24\" text-anchor=\"middle\" fill=\"white\" font-size=\"14\" font-weight=\"bold\">${index + 1}</text>`}\n            ${isPending ? '<circle cx=\"26\" cy=\"10\" r=\"6\" fill=\"orange\" stroke=\"white\" stroke-width=\"2\"/>' : ''}\n          </svg>\n        `), {\n          size: {\n            w: 36,\n            h: 36\n          }\n        });\n        const marker = this.hereMapsService.addMarker(this.map, address.coordinates, {\n          icon\n        });\n        // Agregar evento de clic para mostrar informaci√≥n\n        marker.addEventListener('tap', evt => {\n          const bubble = new H.ui.InfoBubble(`<div style=\"padding: 5px;\">\n            <strong>${isCompleted ? '‚úÖ COMPLETADO' : 'üìç PENDIENTE'}</strong><br>\n            <strong>${index + 1}. ${address.label}</strong><br>\n            <small>Lat: ${address.coordinates.lat.toFixed(4)}, Lng: ${address.coordinates.lng.toFixed(4)}</small>\n            ${this.getDistanceToAddress(address) !== null ? `<br><small>Distancia: ${this.getDistanceToAddress(address)}m</small>` : ''}\n          </div>`, {\n            lat: address.coordinates.lat,\n            lng: address.coordinates.lng\n          });\n          this.ui.addBubble(bubble);\n        });\n        this.routeMarkers.push(marker);\n      });\n    }\n    checkProximityToDeliveryPoints() {\n      if (!this.currentLocation) return;\n      this.savedAddresses.forEach(address => {\n        const distance = this.calculateDistance(this.currentLocation.coordinates, address.coordinates);\n        if (distance < 100 && !this.completedAddresses.has(address.id)) {\n          this.completedAddresses.add(address.id);\n          this.updateRouteMarkers();\n        }\n      });\n    }\n    getSelectedDriverName() {\n      const driver = this.drivers.find(d => d.id === this.selectedDriverId);\n      return driver ? driver.name : '';\n    }\n    isAddressCompleted(address) {\n      return this.completedAddresses.has(address.id);\n    }\n    isCurrentDeliveryPoint(address) {\n      if (!this.currentLocation) return false;\n      const distance = this.calculateDistance(this.currentLocation.coordinates, address.coordinates);\n      return distance < 100;\n    }\n    getDistanceToAddress(address) {\n      if (!this.currentLocation) return null;\n      return Math.round(this.calculateDistance(this.currentLocation.coordinates, address.coordinates));\n    }\n    startSimulation() {\n      this.http.get(`http://localhost:3000/api/simulation/start/${this.selectedDriverId}`).subscribe({\n        next: response => {\n          if (!response.success && response.message !== 'Simulaci√≥n ya est√° activa') {\n            this.trackingError = 'Error al iniciar la simulaci√≥n';\n          }\n        },\n        error: error => {\n          this.trackingError = 'Error de conexi√≥n con el servidor';\n        }\n      });\n    }\n    stopSimulation() {\n      if (this.selectedDriverId) {\n        this.http.get(`http://localhost:3000/api/simulation/stop/${this.selectedDriverId}`).subscribe({\n          error: error => {}\n        });\n      }\n    }\n    static {\n      this.…µfac = function TrackingViewComponent_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || TrackingViewComponent)(i0.…µ…µdirectiveInject(i1.HereMapsService), i0.…µ…µdirectiveInject(i2.AddressService), i0.…µ…µdirectiveInject(i3.HttpClient));\n      };\n    }\n    static {\n      this.…µcmp = /*@__PURE__*/i0.…µ…µdefineComponent({\n        type: TrackingViewComponent,\n        selectors: [[\"app-tracking-view\"]],\n        viewQuery: function TrackingViewComponent_Query(rf, ctx) {\n          if (rf & 1) {\n            i0.…µ…µviewQuery(_c0, 7);\n          }\n          if (rf & 2) {\n            let _t;\n            i0.…µ…µqueryRefresh(_t = i0.…µ…µloadQuery()) && (ctx.trackingMapContainer = _t.first);\n          }\n        },\n        standalone: true,\n        features: [i0.…µ…µStandaloneFeature],\n        decls: 25,\n        vars: 12,\n        consts: [[\"trackingMap\", \"\"], [1, \"card\"], [1, \"form-group\"], [\"for\", \"driverSelect\"], [\"id\", \"driverSelect\", 1, \"form-control\", 3, \"ngModelChange\", \"change\", \"ngModel\"], [\"value\", \"\"], [3, \"value\", 4, \"ngFor\", \"ngForOf\"], [\"class\", \"alert alert-success\", 4, \"ngIf\"], [\"class\", \"alert alert-error\", 4, \"ngIf\"], [1, \"map-container\", 2, \"height\", \"500px\"], [\"class\", \"card\", \"style\", \"margin-top: 20px;\", 4, \"ngIf\"], [\"class\", \"card\", 4, \"ngIf\"], [1, \"form-group\", 2, \"margin-top\", \"20px\"], [1, \"btn\", \"btn-primary\", 3, \"click\", \"disabled\"], [1, \"btn\", \"btn-primary\", 2, \"margin-left\", \"10px\", 3, \"click\", \"disabled\"], [1, \"btn\", \"btn-success\", 2, \"margin-left\", \"10px\", \"background-color\", \"#28a745\", \"border-color\", \"#28a745\", 3, \"click\", \"disabled\"], [1, \"btn\", \"btn-warning\", 2, \"margin-left\", \"10px\", \"background-color\", \"#ffc107\", \"border-color\", \"#ffc107\", \"color\", \"black\", 3, \"click\", \"disabled\"], [3, \"value\"], [1, \"alert\", \"alert-success\"], [1, \"alert\", \"alert-error\"], [1, \"card\", 2, \"margin-top\", \"20px\"], [4, \"ngIf\"], [\"style\", \"margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;\", 4, \"ngIf\"], [2, \"margin-top\", \"15px\", \"padding\", \"10px\", \"background-color\", \"#f8f9fa\", \"border-radius\", \"4px\"], [\"class\", \"delivery-point\", \"style\", \"padding: 10px; border: 1px solid #ddd; margin: 5px 0; border-radius: 4px;\", 3, \"completed\", 4, \"ngFor\", \"ngForOf\"], [1, \"delivery-point\", 2, \"padding\", \"10px\", \"border\", \"1px solid #ddd\", \"margin\", \"5px 0\", \"border-radius\", \"4px\"], [2, \"display\", \"flex\", \"justify-content\", \"space-between\", \"align-items\", \"center\"], [2, \"font-size\", \"12px\", \"color\", \"#666\"], [\"style\", \"color: green; font-weight: bold;\", 4, \"ngIf\"], [\"style\", \"color: orange; font-weight: bold;\", 4, \"ngIf\"], [\"style\", \"font-size: 12px; color: #666;\", 4, \"ngIf\"], [2, \"color\", \"green\", \"font-weight\", \"bold\"], [2, \"color\", \"orange\", \"font-weight\", \"bold\"]],\n        template: function TrackingViewComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            const _r1 = i0.…µ…µgetCurrentView();\n            i0.…µ…µelementStart(0, \"div\", 1)(1, \"h2\");\n            i0.…µ…µtext(2, \"Rastreo en Tiempo Real\");\n            i0.…µ…µelementEnd();\n            i0.…µ…µelementStart(3, \"div\", 2)(4, \"label\", 3);\n            i0.…µ…µtext(5, \"Seleccionar conductor:\");\n            i0.…µ…µelementEnd();\n            i0.…µ…µelementStart(6, \"select\", 4);\n            i0.…µ…µtwoWayListener(\"ngModelChange\", function TrackingViewComponent_Template_select_ngModelChange_6_listener($event) {\n              i0.…µ…µrestoreView(_r1);\n              i0.…µ…µtwoWayBindingSet(ctx.selectedDriverId, $event) || (ctx.selectedDriverId = $event);\n              return i0.…µ…µresetView($event);\n            });\n            i0.…µ…µlistener(\"change\", function TrackingViewComponent_Template_select_change_6_listener() {\n              i0.…µ…µrestoreView(_r1);\n              return i0.…µ…µresetView(ctx.onDriverChange());\n            });\n            i0.…µ…µelementStart(7, \"option\", 5);\n            i0.…µ…µtext(8, \"Selecciona un conductor\");\n            i0.…µ…µelementEnd();\n            i0.…µ…µtemplate(9, TrackingViewComponent_option_9_Template, 2, 2, \"option\", 6);\n            i0.…µ…µelementEnd()();\n            i0.…µ…µtemplate(10, TrackingViewComponent_div_10_Template, 2, 1, \"div\", 7)(11, TrackingViewComponent_div_11_Template, 2, 1, \"div\", 8);\n            i0.…µ…µelement(12, \"div\", 9, 0);\n            i0.…µ…µtemplate(14, TrackingViewComponent_div_14_Template, 22, 10, \"div\", 10)(15, TrackingViewComponent_div_15_Template, 4, 1, \"div\", 11);\n            i0.…µ…µelementStart(16, \"div\", 12)(17, \"button\", 13);\n            i0.…µ…µlistener(\"click\", function TrackingViewComponent_Template_button_click_17_listener() {\n              i0.…µ…µrestoreView(_r1);\n              return i0.…µ…µresetView(ctx.startTracking());\n            });\n            i0.…µ…µtext(18, \" Iniciar Rastreo \");\n            i0.…µ…µelementEnd();\n            i0.…µ…µelementStart(19, \"button\", 14);\n            i0.…µ…µlistener(\"click\", function TrackingViewComponent_Template_button_click_19_listener() {\n              i0.…µ…µrestoreView(_r1);\n              return i0.…µ…µresetView(ctx.stopTracking());\n            });\n            i0.…µ…µtext(20, \" Detener Rastreo \");\n            i0.…µ…µelementEnd();\n            i0.…µ…µelementStart(21, \"button\", 15);\n            i0.…µ…µlistener(\"click\", function TrackingViewComponent_Template_button_click_21_listener() {\n              i0.…µ…µrestoreView(_r1);\n              return i0.…µ…µresetView(ctx.calculateAndShowRoute());\n            });\n            i0.…µ…µtext(22);\n            i0.…µ…µelementEnd();\n            i0.…µ…µelementStart(23, \"button\", 16);\n            i0.…µ…µlistener(\"click\", function TrackingViewComponent_Template_button_click_23_listener() {\n              i0.…µ…µrestoreView(_r1);\n              return i0.…µ…µresetView(ctx.clearRouteLines());\n            });\n            i0.…µ…µtext(24);\n            i0.…µ…µelementEnd()()();\n          }\n          if (rf & 2) {\n            i0.…µ…µadvance(6);\n            i0.…µ…µtwoWayProperty(\"ngModel\", ctx.selectedDriverId);\n            i0.…µ…µadvance(3);\n            i0.…µ…µproperty(\"ngForOf\", ctx.drivers);\n            i0.…µ…µadvance();\n            i0.…µ…µproperty(\"ngIf\", ctx.trackingActive);\n            i0.…µ…µadvance();\n            i0.…µ…µproperty(\"ngIf\", ctx.trackingError);\n            i0.…µ…µadvance(3);\n            i0.…µ…µproperty(\"ngIf\", ctx.currentLocation);\n            i0.…µ…µadvance();\n            i0.…µ…µproperty(\"ngIf\", ctx.savedAddresses.length > 0);\n            i0.…µ…µadvance(2);\n            i0.…µ…µproperty(\"disabled\", !ctx.selectedDriverId || ctx.trackingActive);\n            i0.…µ…µadvance(2);\n            i0.…µ…µproperty(\"disabled\", !ctx.trackingActive);\n            i0.…µ…µadvance(2);\n            i0.…µ…µproperty(\"disabled\", !ctx.currentLocation || ctx.savedAddresses.length === 0);\n            i0.…µ…µadvance();\n            i0.…µ…µtextInterpolate1(\" Mostrar Ruta Optimizada (\", ctx.savedAddresses.length, \" direcciones) \");\n            i0.…µ…µadvance();\n            i0.…µ…µproperty(\"disabled\", ctx.routeLines.length === 0);\n            i0.…µ…µadvance();\n            i0.…µ…µtextInterpolate1(\" Ocultar Ruta (\", ctx.routeLines.length, \" l\\u00EDneas) \");\n          }\n        },\n        dependencies: [CommonModule, i4.NgForOf, i4.NgIf, i4.DatePipe, FormsModule, i5.NgSelectOption, i5.…µNgSelectMultipleOption, i5.SelectControlValueAccessor, i5.NgControlStatus, i5.NgModel],\n        styles: [\".delivery-point.completed[_ngcontent-%COMP%]{background-color:#d4edda;border-color:#c3e6cb}\"]\n      });\n    }\n  }\n  return TrackingViewComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}